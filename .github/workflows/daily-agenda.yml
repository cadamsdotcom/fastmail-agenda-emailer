name: Send Daily Agenda

on:
  schedule:
    # Two cron times to cover both AEST and AEDT — a guard step skips the wrong one
    - cron: "0 18 * * *"  # 5am AEDT (UTC+11, summer)
    - cron: "0 19 * * *"  # 5am AEST (UTC+10, winter)

  # Allow manual trigger from the Actions tab
  workflow_dispatch:

jobs:
  send-agenda:
    runs-on: ubuntu-latest

    steps:
      - name: Check if 5am local time
        if: github.event_name == 'schedule'
        run: |
          HOUR=$(TZ="Australia/Sydney" date +%H)
          if [ "$HOUR" != "05" ]; then
            echo "Current hour in Sydney is $HOUR, not 05. Skipping."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Send daily agenda email
        env:
          FASTMAIL_USERNAME: ${{ secrets.FASTMAIL_USERNAME }}
          FASTMAIL_APP_PASSWORD: ${{ secrets.FASTMAIL_APP_PASSWORD }}
          # Optional overrides — only add these secrets if needed:
          CALDAV_URL: ${{ secrets.CALDAV_URL }}
          SEND_TO: ${{ secrets.SEND_TO }}
          CALENDAR_NAMES: ${{ secrets.CALENDAR_NAMES }}
          DISPLAY_NAME: ${{ secrets.DISPLAY_NAME }}
        run: uv run daily_agenda.py
